<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BottlePoints</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; }
    h1 { color: #2c3e50; }
    label, input, button { margin: 5px; padding: 8px; }
    #sendEmailBtn:disabled { background: #aaa; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>‚ôªÔ∏è BottlePoints</h1>

  <!-- User Email -->
  <label for="emailInput">Enter your Email:</label>
  <input type="email" id="emailInput" placeholder="you@example.com"><br>

  <!-- Firebase Data -->
  <label>Bottle Count: <span id="bottleCount">0</span></label><br>
  <label>Credits: <span id="credits">0</span></label><br><br>

  <!-- Manual Inputs -->
  <label for="manualBottles">Bottles:</label>
  <input type="number" id="manualBottles" value="0" min="0"><br>
  <label for="manualCredits">Credits:</label>
  <input type="number" id="manualCredits" value="0" min="0"><br><br>

  <!-- Buttons -->
  <button id="getDataBtn">Get Data</button>
  <button id="updateDataBtn">Update Data</button><br><br>
  <button id="sendEmailBtn" disabled>Email me my points</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    // Initialize EmailJS
    (function(){ emailjs.init("o7r8YfCHY4c2ks-x8"); })();
  </script>

  <script>
    // üîê Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBH1YR29VHK4pJzcYMpKGgiUDBxH6clccA",
      authDomain: "bottlepoints-60dc8.firebaseapp.com",
      databaseURL: "https://bottlepoints-60dc8-default-rtdb.firebaseio.com",
      projectId: "bottlepoints-60dc8",
      storageBucket: "bottlepoints-60dc8.firebasestorage.app",
      messagingSenderId: "507941735663",
      appId: "1:507941735663:web:ade66e1a5723248741df1a"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM Elements
    const emailInput = document.getElementById("emailInput");
    const bottleLabel = document.getElementById("bottleCount");
    const creditsLabel = document.getElementById("credits");
    const manualBottlesInput = document.getElementById("manualBottles");
    const manualCreditsInput = document.getElementById("manualCredits");
    const getDataBtn = document.getElementById("getDataBtn");
    const updateDataBtn = document.getElementById("updateDataBtn");
    const sendEmailBtn = document.getElementById("sendEmailBtn");

    // App State
    let currentBottles = 0;
    let currentCredits = 0;

    // Enable Email button if email is valid
    function refreshEmailButtonState() {
      const email = emailInput.value.trim();
      const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      sendEmailBtn.disabled = !valid || currentBottles < 0 || currentCredits < 0;
    }

    emailInput.addEventListener("input", refreshEmailButtonState);

    function updateCurrentData(bottles, credits) {
      currentBottles = bottles;
      currentCredits = credits;
      bottleLabel.innerText = bottles;
      creditsLabel.innerText = credits;
      manualBottlesInput.value = bottles;
      manualCreditsInput.value = credits;
      refreshEmailButtonState();
    }

    // Get Data from Firebase
    getDataBtn.addEventListener("click", () => {
      const email = emailInput.value.trim();
      if (!email) return alert("Enter a valid email!");
      const encodedEmail = email.replace('.', ',');

      db.ref("users/" + encodedEmail).once("value").then(snapshot => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          updateCurrentData(data.bottleCount || 0, data.credits || 0);
        } else {
          alert("No data found for this email.");
          updateCurrentData(0, 0);
        }
      }).catch(err => console.error(err));
    });

    // Update Data in Firebase
    updateDataBtn.addEventListener("click", () => {
      const email = emailInput.value.trim();
      if (!email) return alert("Enter a valid email!");
      const encodedEmail = email.replace('.', ',');

      const newBottles = parseInt(manualBottlesInput.value) || 0;
      const newCredits = parseInt(manualCreditsInput.value) || 0;

      db.ref("users/" + encodedEmail).set({
        bottleCount: newBottles,
        credits: newCredits
      }).then(() => {
        updateCurrentData(newBottles, newCredits);
        alert(‚úÖ Updated! Bottles: ${newBottles}, Credits: ${newCredits});
      }).catch(err => {
        console.error(err);
        alert("‚ùå Update failed. Check console for details.");
      });
    });

    // Send Email via EmailJS
    sendEmailBtn.addEventListener("click", () => {
      const email = emailInput.value.trim();
      if (!email) return alert("Enter a valid email!");

      emailjs.send("service_9xv218b", "template_m9ezdw4", {
        user_email: email,
        bottles: currentBottles,
        credits: currentCredits
      }).then(() => {
        alert(‚úÖ Email sent to ${email});
      }).catch(err => {
        console.error(err);
        alert("‚ùå Email failed. Check console for details.");
      });
    });
  </script>
</body>
</html>
